<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no">
    <title>正在加载...</title>
    <script type="text/javascript" src="http://node.dobooking.cn/minify.min.js"></script>
    <script type="text/javascript" src="http://node.dobooking.cn/js.cookie.js"></script>
   <!-- <script type="application/javascript" src="http://g.tbcdn.cn/mtb/lib-flexible/0.3.2/??flexible_css.js,flexible.js"></script>-->
   <!-- <link rel="stylesheet" type="text/css" href="http://localhost:3000/main.css" />-->

   <!-- <script type="text/javascript" src="http://localhost:3000/common.js"></script>-->

</head>

<body>
<div id='root'>
</div>
<script type="application/javascript">


    /**
     * 	作用：格式化参数，签名过程需要使用
     */
    var formatBizQueryParaMap = function (args) {
        var keys = Object.keys(args);
        keys = keys.sort()
        var newArgs = {};
        keys.forEach(function (key) {
            newArgs[key] = args[key];
        });

        var string = '';
        for (var k in newArgs) {
            string += '&' + k + '=' + newArgs[k];
        }
        string = string.substr(1);
        return string;
    };

    /**
     * 	作用：生成可以获得code的url
     */
    var createOauthUrlForCode = function (appId,redirectUrl,state){
        var urlJson = {};

        urlJson["appid"] = appId;
        urlJson["redirect_uri"] = encodeURIComponent(redirectUrl);
        urlJson["response_type"] = "code";
        urlJson["scope"] = "snsapi_base";
        urlJson["state"] = state;

        var bizString = formatBizQueryParaMap(urlJson) + "#wechat_redirect";

        return "https://open.weixin.qq.com/connect/oauth2/authorize?" + bizString;
    }

    var page = '{{query.page}}';
    var channel = {{channel}};
    var code = {{#if query.code}} '{{query.code}}' {{else}} undefined {{/if}};

    var agentid = {{#if query.agentid}} {{query.agentid}} {{else}} -1 {{/if}};

    var agent_type = {{#if query.agent_type}} {{query.agent_type}} {{else}} -1 {{/if}};

    var wxHostName = "http://node.dobooking.cn";

    var open_id = Cookies.get('my_wxopenid'); // => 'value'
    //var agentid = Cookies.get('agentid'); // => 'value'

    console.log(open_id)
    console.log(agentid,page)

    var goToPage = function(open_id){

        if(page == "product"){
            console.log(page)
            document.location.href = '/client/page/product/list/' + channel + "/" + open_id +"?agentid="+agentid+"&agentType="+agent_type
        }else if(page == "order"){
            //订单列表
            document.location.href = '/client/page/order/list/' + channel + "/" + open_id +"?agentid="+agentid+"&agentType="+agent_type
        }else if(page == "weixinshu"){
            //微信书
            document.location.href = "http://weprint.snsunion.cn/wxbookrack?open_id=" + open_id ;
        }else if(page == "album"){
            //照片书
            document.location.href = '/client/page/album/list/' + channel + "/" + open_id +"?agentid="+agentid+"&agentType="+agent_type
        }else if(page == "cal"){
            document.location.href = '/client/page/cal/list/' + channel + "/" + open_id +"?agentid="+agentid+"&agentType="+agent_type
        }else if(page == "zschupin"){
            document.location.href = '/client/page/public/updating/13/1';
        }else if(page == "zshuodong"){
            document.location.href = '/client/page/public/updating/13/1';
        }else if(page == "proxy") {
            document.location.href = '/client/page/proxy/' + channel + "/" + open_id +"?agentid="+agentid+"&agentType="+agent_type
        }else if(page == "addorder") {
            //十二笙箫
            //http://node.dobooking.cn/client/page/shop/addorder/13/od-5Ut75Nw6AJmiAIS8UnT-A6jDg/764041
            document.location.href = "/client/page/shop/addorder/" + channel + "/" + open_id + "/764041?agentid="+agentid+"&agentType="+agent_type
        }else if(page == "alumni") {
            var _dataid = '{{query.dataid}}';
            //http://node.dobooking.cn/client/page/shop/addorder/13/od-5Ut75Nw6AJmiAIS8UnT-A6jDg/764041
            document.location.href = "http://devnode.dobooking.cn/client/page/alumni/add/" + channel + "/" + open_id + "/"+_dataid+"/10"
        }else{
            document.location.href = '/client/page/public/updating/13/1';
        }
    }

    if(open_id == undefined || open_id == 'undefined') {

        if (code == undefined) {

            var url = createOauthUrlForCode("wxcdf9cad8bd2d21c9", wxHostName + '/wxredirect/' + channel + "?page=" + page + "&agentid="+agentid+"&agentType="+agent_type, 1);
            //console.log(url)
            if(page == "alumni"){
                //http://node.dobooking.cn/wxredirect/13?page=alumni&dataid=766911
                var _dataid = '{{query.dataid}}';
                url = createOauthUrlForCode("wxcdf9cad8bd2d21c9", wxHostName + '/wxredirect/' + channel + "?page=" + page + "&dataid="+_dataid+"&productid=10", 1);
            }

            document.location.href = url
        } else {

            minAjax({
                url: "/remote/wxproxy/wxproxy/getOpenidByCode/" + channel + "/" + code,//request URL
                type: "GET",//Request type GET/POST
                //Send Data in form of GET/POST
                data: {},
                //CALLBACK FUNCTION with RESPONSE as argument
                success: function (data) {
                    //alert(data);
                    //console.log(data)
                    data = JSON.parse(data);

                    if(data.code == 0){
                        open_id = data.object.openid;
                        //alert(open_id)
                        Cookies.set("my_wxopenid",open_id,{path:"/",expires: 1})
                        //Cookies.set("channel",channel,{path:"/",expires: 1})
                        console.log(channel)
                        goToPage(open_id)
                    }
                }
            });
        }
    }else{
        goToPage(open_id)
    }

</script>
</body>

</html>